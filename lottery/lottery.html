<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿æŠ½å¥– - SuperPower</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" type="image/x-ico" href="/images/logo.png" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/index.css">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* =========================================
           æŠ½å¥–é¡µé¢ä¸“ç”¨æ ·å¼ (Lottery Specific Styles)
           ========================================= */

        /* å¸ƒå±€å®¹å™¨ */
        .lottery-section {
            padding: 4rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 70vh;
        }

        .lottery-header h2 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .lottery-header p {
            color: #6B7280;
            margin-bottom: 3rem;
        }

        /* --- å˜é‡å®šä¹‰ --- */
        :root {
            --card-width: 140px;
            --card-height: 140px;
            --gap: 10px;
            --visible-cards: 5; 
        }

        /* --- 3D åœ†ç­’å®¹å™¨ --- */
        .raffle-window {
            position: relative;
            /* å®½åº¦ = (å¡ç‰‡å®½+é—´è·)*æ•°é‡ - æœ€åä¸€ä¸ªé—´è· */
            width: calc((var(--card-width) + var(--gap)) * var(--visible-cards) - var(--gap));
            max-width: 100vw; /* é˜²æ­¢æ‰‹æœºæº¢å‡º */
            height: calc(var(--card-height) + 40px); /* ç•™å‡ºé˜´å½±ç©ºé—´ */
            
            background: #F3F4F6; /* æµ…è‰²æ¨¡å¼èƒŒæ™¯ */
            border-radius: 4px; 
            
            /* æ ¸å¿ƒï¼šä¸¤ç«¯æ¸å˜æ¶ˆå¤±é®ç½© */
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 15%, black 85%, transparent 100%);
            mask-image: linear-gradient(to right, transparent 0%, black 15%, black 85%, transparent 100%);

            /* æ ¸å¿ƒï¼šå†…é˜´å½±æ¨¡æ‹Ÿåœ†ç­’ç«‹ä½“æ„Ÿ */
            box-shadow: inset 0 15px 20px -10px rgba(0,0,0,0.15), 
                        inset 0 -15px 20px -10px rgba(0,0,0,0.15);
            
            margin-bottom: 2rem;
            overflow: hidden;
            perspective: 1000px;
        }

        /* --- æ»šåŠ¨è½¨é“ --- */
        .raffle-track {
            display: flex;
            gap: var(--gap);
            padding-left: calc(50% - var(--card-width)/2); /* å±…ä¸­å¯¹é½èµ·å§‹ç‚¹ */
            will-change: transform;
            height: 100%;
            align-items: center;
            transform-style: preserve-3d;
        }

        /* --- å¥–å“å¡ç‰‡ --- */
        .l-card {
            width: var(--card-width);
            height: var(--card-height);
            background: #ffffff;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            
            /* é˜´å½±è®©å¡ç‰‡æµ®èµ· */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0,0,0,0.1);
            border-bottom: 4px solid transparent; /* åŠ ç²—ä¸€ç‚¹ï¼Œè®©é¢œè‰²æ›´æ˜æ˜¾ */
        }

        .l-card img {
            width: 65%;
            height: 65%;
            object-fit: contain;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .l-card p {
            font-size: 18px;
            margin: 0;
            font-weight: 600;
            color: #374151;
            width: 90%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* åº“å­˜æ–‡å­— */
        .stock-tag {
            font-size: 14px;
            color: #9CA3AF;
            margin-top: 2px;
        }

        .rare-gold { border-bottom-color: #F59E0B !important; }
        .rare-purple { border-bottom-color: #8B5CF6 !important; }
        .rare-blue { border-bottom-color: #3B82F6 !important; }

        /* --- ä¸­é—´æŒ‡é’ˆ --- */
        .marker {
            position: absolute;
            top: 10px;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            /* æµ…è‰²æ¨¡å¼æŒ‡é’ˆï¼šç´«è‰² */
            background: linear-gradient(to bottom, transparent, #4338CA 20%, #4338CA 80%, transparent);
            z-index: 20;
            box-shadow: 0 0 10px rgba(67, 56, 202, 0.5);
            border-radius: 2px;
        }
        .marker::before, .marker::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
        }
        .marker::before { top: -2px; border-top: 10px solid #4338CA; }
        .marker::after { bottom: -2px; border-bottom: 10px solid #4338CA; }

        /* --- ç»“æœæ˜¾ç¤ºæ–‡å­— --- */
        #result-display {
            font-size: 1.5rem;
            font-weight: 700;
            min-height: 2rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            color: #111827;
        }

        /* =========================================
           æ·±è‰²æ¨¡å¼é€‚é… (Dark Mode Overrides)
           ========================================= */
        
        body.dark-mode .lottery-header p { color: #A0A0A0; }
        body.dark-mode #result-display { color: #F9FAFB; }

        body.dark-mode .raffle-window {
            background: #18181B; /* æ·±è‰²åœ†ç­’å†…éƒ¨ */
            /* åŠ æ·±å†…é˜´å½± */
            box-shadow: inset 0 20px 30px -10px rgba(0,0,0,1), 
                        inset 0 -20px 30px -10px rgba(0,0,0,1);
        }

        body.dark-mode .l-card {
            background: linear-gradient(145deg, #27272A, #1F1F22);
            
            /* å…³é”®ä¿®æ”¹ï¼šåªæ”¹å˜ä¸Šã€å·¦ã€å³çš„è¾¹æ¡†é¢œè‰²ï¼Œä¸è¦åŠ¨åº•éƒ¨ */
            border-top: 1px solid rgba(255,255,255,0.08);
            border-left: 1px solid rgba(255,255,255,0.08);
            border-right: 1px solid rgba(255,255,255,0.08);
            /* åº•éƒ¨ä¿æŒç”± rarity ç±»æ§åˆ¶ï¼Œæˆ–è€…é»˜è®¤é€æ˜ */
            border-bottom: 4px solid transparent; 
            
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .l-card p { color: #E5E7EB; }

        /* æ·±è‰²æ¨¡å¼æŒ‡é’ˆï¼šç»¿è‰² (åŒ¹é…ä¸»é¡µé£æ ¼) */
        body.dark-mode .marker {
             background: linear-gradient(to bottom, transparent, #34D399 20%, #34D399 80%, transparent);
             box-shadow: 0 0 15px #34D399;
        }
        body.dark-mode .marker::before { border-top-color: #34D399; }
        body.dark-mode .marker::after { border-bottom-color: #34D399; }

        /* ç¨€æœ‰åº¦å‘å…‰å¢å¼º */
        body.dark-mode .rare-gold { box-shadow: 0 5px 15px rgba(245, 158, 11, 0.15); }
        body.dark-mode .rare-purple { box-shadow: 0 5px 15px rgba(139, 92, 246, 0.15); }

        /* =========================================
           ç§»åŠ¨ç«¯é€‚é…
           ========================================= */
        @media (max-width: 768px) {
            :root {
                --card-width: 100px;
                --card-height: 100px;
                --visible-cards: 3; /* æ‰‹æœºåªæ˜¾ç¤º3ä¸ª */
            }
        }

        /* === å¥–æ± åº“å­˜å±•ç¤ºæ ·å¼ === */
        .pool-section {
            margin-top: 3rem;
            width: 100%;
            max-width: 1300px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            padding: 0 1rem;
        }

        .pool-section h3 {
            margin-bottom: 1.5rem;
            color: #4B5563;
            font-size: 1.2rem;
        }
        body.dark-mode .pool-section h3 { color: #D1D5DB; }

        /* === å¥–æ± åˆ—è¡¨å®¹å™¨ (å¹³é“ºå‡åˆ†ç‰ˆ) === */
        .pool-grid {
            display: flex;
            flex-wrap: nowrap;       /* å¼ºåˆ¶ä¸æ¢è¡Œ */
            justify-content: center; /* å±…ä¸­æ˜¾ç¤º */
            gap: 10px;               /* ç¨å¾®å‡å°é—´è·ï¼Œçœç©ºé—´ */
            width: 100%;
        }

        /* === å¥–æ± å•ä¸ªå¡ç‰‡ (è‡ªåŠ¨ä¼¸ç¼©) === */
        .pool-item {
            flex: 1;                 /* å…³é”®ï¼šå¤§å®¶å‡åˆ†å®½åº¦ */
            min-width: 50px;            /* å…³é”®ï¼šå…è®¸è¢«å‹ç¼©åˆ°æ¯”å†…å®¹æ›´çª„ï¼Œé˜²æ­¢æ’‘çˆ†å±å¹• */
            
            background: #fff;
            border-radius: 8px;
            padding: 8px 4px;        /* å‡å°å†…è¾¹è·ï¼Œçœç©ºé—´ */
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        body.dark-mode .pool-item {
            background: #27272A;
            border-color: rgba(255,255,255,0.05);
        }

        .pool-item.sold-out {
            opacity: 0.4;
            filter: grayscale(100%);
        }

        .pool-item img {
            width: 100%;            /* å›¾ç‰‡å®½åº¦è·Ÿéšå¡ç‰‡ */
            max-width: 100px;        /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªå¤§ */
            height: auto;
            aspect-ratio: 1/1;      /* ä¿æŒæ­£æ–¹å½¢æ¯”ä¾‹ */
            object-fit: contain;
            margin-bottom: 5px;
        }

        .pool-item .name {
            font-size: 11px;        /* å­—ä½“ç¨å¾®æ”¹å°ä¸€ç‚¹ */
            font-weight: 600;
            text-align: center;
            width: 100%;
            
            /* åå­—å¤ªé•¿å°±æ˜¾ç¤ºçœç•¥å·ï¼Œé˜²æ­¢æ¢è¡Œæ’‘åå¸ƒå±€ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        body.dark-mode .pool-item .name { color: #eee; }

        .pool-item .stock {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #E5E7EB;
            color: #374151;
            margin-top: 2px;
            
            /* é˜²æ­¢åº“å­˜æ–‡å­—æ¢è¡Œ */
            white-space: nowrap;
        }
        body.dark-mode .pool-item .stock { background: #3F3F46; color: #9CA3AF; }

        /* ç¨€æœ‰åº¦åœ†ç‚¹ (ç¨å¾®è°ƒå°ä¸€ç‚¹) */
        .rarity-dot {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .dot-gold { background: #F59E0B; box-shadow: 0 0 5px #F59E0B; }
        .dot-purple { background: #8B5CF6; box-shadow: 0 0 5px #8B5CF6; }
        .dot-blue { background: #3B82F6; box-shadow: 0 0 5px #3B82F6; }
        .dot-red { background: #DC2626; box-shadow: 0 0 5px #DC2626; }

        /* === æ–°å¢ï¼šæ¨ªå‘æ»šåŠ¨æ¡ç¾åŒ– (è®©å®ƒçœ‹èµ·æ¥æ›´ç²¾è‡´) === */
        .pool-grid::-webkit-scrollbar {
            height: 6px;               /* æ»šåŠ¨æ¡é«˜åº¦ */
        }

        .pool-grid::-webkit-scrollbar-track {
            background: transparent;   /* è½¨é“é€æ˜ */
        }

        .pool-grid::-webkit-scrollbar-thumb {
            background-color: #E5E7EB; /* æµ…ç°è‰²æ»‘å— */
            border-radius: 10px;       /* åœ†è§’ */
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ»šåŠ¨æ¡ */
        body.dark-mode .pool-grid::-webkit-scrollbar-thumb {
            background-color: #3F3F46; /* æ·±ç°è‰²æ»‘å— */
        }


        /* =========================================
        å¤§å±å¹•ä¼˜åŒ– (Large Screen Optimization)
        ========================================= */

        /* å½“å±å¹•å®½åº¦å¤§äº 1200px æ—¶ (PCç«¯) */
        @media (min-width: 1200px) {
            :root {
                /* å¢åŠ å¯è§†å¡ç‰‡æ•°é‡ï¼šä» 5 å¼ å˜æˆ 7 å¼  */
                /* æˆ‘ä»¬çš„ JS ä¼šè‡ªåŠ¨è¯»å–è¿™ä¸ªå˜é‡æ¥è®¡ç®—å®½åº¦ï¼Œæ‰€ä»¥æ— éœ€æ”¹ JS */
                --visible-cards: 7; 
                
                /* ç¨å¾®è°ƒå¤§ä¸€ç‚¹å¡ç‰‡å°ºå¯¸ï¼Œæ›´å¤§æ°” */
                --card-width: 220px;
                --card-height: 220px;
            }

            .lottery-header h2 {
                font-size: 3.5rem; /* æ ‡é¢˜å­—å·åŠ å¤§ */
            }

            .raffle-window {
                /* åŠ å¼ºé˜´å½±æ·±åº¦ï¼Œé€‚åº”å¤§å°ºå¯¸ */
                box-shadow: inset 0 20px 30px -10px rgba(0,0,0,0.2), 
                            inset 0 -20px 30px -10px rgba(0,0,0,0.2);
            }
            
            body.dark-mode .raffle-window {
                box-shadow: inset 0 25px 40px -12px rgba(0,0,0,1), 
                            inset 0 -25px 40px -12px rgba(0,0,0,1);
            }
        }

        /* å½“å±å¹•å®½åº¦å¤§äº 1600px æ—¶ (è¶…å®½å±/4K) */
        @media (min-width: 1600px) {
            :root {
                /* æ˜¾ç¤º 9 å¼ å¡ç‰‡ï¼Œéœ¸å±æ•ˆæœ */
                --visible-cards: 9; 
            }
        }

        /* === æ–°å¢ï¼šçº¢è‰²ç¨€æœ‰åº¦ (Red / Arcana) === */
        .rare-red { 
            border-bottom-color: #DC2626 !important; /* é²œè‰³çš„çº¢ */
        }
        body.dark-mode .rare-red {
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.25); /* çº¢è‰²å…‰æ™• */
        }

        /* å¥–æ± åˆ—è¡¨çš„å°çº¢ç‚¹ */
        .dot-red { 
            background: #DC2626; 
            box-shadow: 0 0 6px #DC2626; 
        }

        /* === æ–‡å­—é—ªçƒç‰¹æ•ˆ (Blinking Text) === */
        @keyframes text-flash {
            0% { opacity: 1; transform: scale(1); filter: brightness(100%); }
            50% { opacity: 0.8; transform: scale(1.05); filter: brightness(130%); }
            100% { opacity: 1; transform: scale(1); filter: brightness(100%); }
        }

        .text-glow-gold {
            color: #F59E0B !important;
            text-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
            animation: text-flash 1.2s infinite ease-in-out; /* æ‚ é•¿çš„é‡‘è‰²å‘¼å¸ */
        }

        .text-glow-red {
            color: #DC2626 !important;
            text-shadow: 0 0 30px rgba(220, 38, 38, 1);
            animation: text-flash 0.6s infinite ease-in-out; /* æ€¥ä¿ƒçš„çº¢è‰²è­¦æŠ¥é—ªçƒ */
        }
    </style>
</head>

<body class="dark-mode">

    <div class="background-blur"></div>

    <aside class="floating-buttons">
        <button class="float-btn">ğŸŒ™</button>
        <button class="float-btn" onclick="scrollToTop()">â¬†ï¸</button>
    </aside>

    <div class="container">

        <header class="navbar">
            <div class="nav-left">
                <a href="/index.html" class="nav-logo">åŒæµSuperPower</a>
            </div>
            <nav class="nav-right">
                <a href="/index.html" class="nav-link">Home</a>
                <a href="/about/about.html" class="nav-link">About</a>
                <a href="https://space.bilibili.com/651837546" class="nav-link" target="_blank">Lectures</a>
                <div class="nav-divider"></div>
                <a href="https://github.com/TongjiSuperPower" class="nav-icon">Github</a>
            </nav>
        </header>

        <main class="lottery-section">
            
            <div class="lottery-header">
                <h1><span class="gradient-text">SPç¬‘è°ˆä¹‹</span>æŠ½æŠ½å¥–</h1>
                <p>å¿«æ¥ç‹ ç‹ æŠ½æˆ‘å§ï¼</p>
            </div>

            <div class="raffle-window">
                <div class="marker"></div>
                <div class="raffle-track" id="track">
                    </div>
            </div>

            <div id="result-display">å‡†å¤‡å°±ç»ª...</div>

            <button id="spinBtn" class="btn btn-primary" onclick="startSpin()" style="padding: 1rem 3rem; font-size: 1.1rem;">
                ç«‹å³æŠ½å¥–
            </button>
            
            <div style="margin-top: 20px;">
                <button onclick="resetData()" style="background:none; border:none; color:#666; font-size:12px; cursor:pointer; text-decoration:underline;">
                    é‡ç½®åº“å­˜æ•°æ®
                </button>
            </div>

            <div class="pool-section">
                <h3>å½“å‰å¥–æ± ä¸€è§ˆ</h3>
                <div class="pool-grid" id="pool-grid">
                    </div>
            </div>

        </main>

    </div>

    <script>
        // === æ–°å¢å‡½æ•°ï¼šæ¸²æŸ“ä¸‹æ–¹å¥–æ± åˆ—è¡¨ ===
        function renderPrizePool() {
            const poolGrid = document.getElementById('pool-grid');
            poolGrid.innerHTML = ''; // æ¸…ç©ºå½“å‰å†…å®¹

            prizes.forEach(prize => {
                // åˆ¤æ–­ç¨€æœ‰åº¦é¢œè‰²
                let dotClass = 'dot-blue';
                if (prize.rarity === 'rare-gold') dotClass = 'dot-gold';
                if (prize.rarity === 'rare-purple') dotClass = 'dot-purple';
                if (prize.rarity === 'rare-red') dotClass = 'dot-red'; // ğŸ‘ˆ æ–°å¢è¿™ä¸€è¡Œ

                // åˆ¤æ–­æ˜¯å¦å”®ç½„
                const isSoldOut = prize.stock <= 0;
                
                // å›¾ç‰‡å¤„ç†
                const imgUrl = prize.img.startsWith('/') 
                    ? prize.img 
                    : `https://placehold.co/100x100/png?text=${prize.name.substring(0,1)}`;

                const div = document.createElement('div');
                div.className = `pool-item ${isSoldOut ? 'sold-out' : ''}`;
                div.innerHTML = `
                    <div class="rarity-dot ${dotClass}"></div>
                    <img src="${imgUrl}" alt="${prize.name}">
                    <div class="name">${prize.name}</div>
                    <div class="stock">${isSoldOut ? 'æŠ½å®Œå“©' : 'å‰©: ' + prize.stock}</div>
                `;
                poolGrid.appendChild(div);
            });
        }

        // ==========================================
        // 1. åŸºç¡€ UI äº¤äº’ (ä¸»é¢˜åˆ‡æ¢)
        // ==========================================
        const themeToggleBtn = document.querySelector('.floating-buttons .float-btn:first-child');
        const body = document.body;
        const currentTheme = localStorage.getItem('theme');

        if (currentTheme === 'light') {
            body.classList.remove('dark-mode');
            themeToggleBtn.innerHTML = 'ğŸŒ™';
        } else {
            body.classList.add('dark-mode');
            themeToggleBtn.innerHTML = 'â˜€ï¸';
        }

        themeToggleBtn.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            themeToggleBtn.innerHTML = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // 2. æŠ½å¥–æ•°æ®é…ç½® (è¯·ä¿®æ”¹è¿™é‡Œ)
        // ==========================================
        
        // id: å”¯ä¸€æ ‡è¯†
        // weight: æƒé‡ (æ•°å­—è¶Šå¤§è¶Šå®¹æ˜“ä¸­)
        // stock: åˆå§‹åº“å­˜
        // rarity: å†³å®šé¢œè‰²å’Œç‰¹æ•ˆ (rare-blue, rare-purple, rare-gold)
        const defaultPrizes = [
            { id: 1, name: "é˜Ÿå†…3Dæ‰“å°å‘¨è¾¹", img: "/images/sp_3d.jpg", rarity: "rare-blue", weight: 60, stock: 30 },
            { id: 2, name: "SP ç¬”è®°æœ¬", img: "/images/sp_benzi.jpg", rarity: "rare-blue", weight: 50, stock: 5 },
            { id: 3, name: "DJI å†°ç®±è´´", img: "/images/dji_bxt.jpg", rarity: "rare-purple", weight: 30, stock: 21 },
            { id: 4, name: "å›½èµ›å…«å¼ºPCBçºªå¿µæ¿", img: "/images/pcb.jpg", rarity: "rare-gold", weight: 10, stock: 8 },
            { id: 5, name: "DJI å¸†å¸ƒè¢‹", img: "/images/dji_fbd.jpg", rarity: "rare-gold", weight: 10, stock: 2 } ,
            { id: 6, name: "DJI è¿·ä½ æ–œæŒåŒ…", img: "/images/dji_xkb.jpg", rarity: "rare-gold", weight: 10, stock: 1 } ,
            { id: 7, name: "DJI é›¨ä¼", img: "/images/dji_ys.jpg", rarity: "rare-red", weight: 5, stock: 2 } ,
            { id: 8, name: "DJI é¸­èˆŒå¸½", img: "/images/dji_ysm.jpg", rarity: "rare-red", weight: 5, stock: 1 } 
        ];

        // è¯»å–æœ¬åœ°å­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
        let prizes = JSON.parse(localStorage.getItem('sp_lottery_data')) || JSON.parse(JSON.stringify(defaultPrizes));

        // ==========================================
        // 3. æ ¸å¿ƒé€»è¾‘å˜é‡
        // ==========================================
        const track = document.getElementById('track');
        const resultDisplay = document.getElementById('result-display');
        const spinBtn = document.getElementById('spinBtn');
        
        // åŠ¨ç”»å‚æ•°
        const WINNER_INDEX = 65; // ä¸­å¥–å¡ç‰‡å¿…é¡»å‡ºç°åœ¨ç¬¬ 65 ä½
        const TOTAL_CARDS = 80;  // æ¯æ¬¡ç”Ÿæˆ 80 å¼ å¡ç”¨äºæ»šåŠ¨
        const SPIN_DURATION = 5000; // åŠ¨ç”»æ—¶é•¿ 6ç§’
        let isSpinning = false;

        // ä¿å­˜æ•°æ®
        function saveData() {
            localStorage.setItem('sp_lottery_data', JSON.stringify(prizes));
        }

        // é‡ç½®æ•°æ®
        function resetData() {
            if(confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å¥–å“åº“å­˜å—ï¼Ÿ')) {
                localStorage.removeItem('sp_lottery_data');
                location.reload();
            }
        }

        // è®¡ç®— CSS å˜é‡ (å®½åº¦è‡ªé€‚åº”)
        function getCardDimensions() {
            const style = getComputedStyle(document.documentElement);
            const w = parseInt(style.getPropertyValue('--card-width'));
            const g = parseInt(style.getPropertyValue('--gap'));
            return { width: w, gap: g, total: w + g };
        }

        // ==========================================
        // 4. æŠ½å¥–ç®—æ³• & æ¸²æŸ“
        // ==========================================

        // åŠ æƒéšæœºç®—æ³•
        function getWinner() {
            // è¿‡æ»¤æ‰æ²¡åº“å­˜çš„
            const availablePrizes = prizes.filter(p => p.stock > 0);
            if (availablePrizes.length === 0) return null;

            const totalWeight = availablePrizes.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            
            for (let p of availablePrizes) {
                if (random < p.weight) return p;
                random -= p.weight;
            }
            return availablePrizes[0];
        }

        // ==========================================
        // åˆå§‹åŒ–è½¨é“ (æ— è¯±é¥µç‰ˆï¼Œä»…å±•ç¤ºæœ‰åº“å­˜å•†å“)
        // ==========================================
        function initTrack(winnerPrize = null) {
            track.innerHTML = '';

            // 1. ç­›é€‰æœ‰åº“å­˜çš„å¥–å“
            let activePrizes = prizes.filter(p => p.stock > 0);
            
            // å…œåº•ï¼šä¸‡ä¸€å…¨å–å…‰äº†ï¼Œå°±ç”¨æ‰€æœ‰å¥–å“å¡«å……èƒŒæ™¯ï¼Œé˜²æ­¢ç©ºç™½
            if (activePrizes.length === 0) activePrizes = prizes;

            for (let i = 0; i < TOTAL_CARDS; i++) {
                let prizeToShow;

                if (i === WINNER_INDEX && winnerPrize) {
                    // ä¸­å¥–ä½ç½®ï¼šå¿…é¡»æ˜¯å®ƒ
                    prizeToShow = winnerPrize;
                } else {
                    // å…¶ä»–ä½ç½®ï¼šçº¯éšæœºï¼Œä»æœ‰åº“å­˜çš„åˆ—è¡¨é‡Œæ‹¿
                    // ä¸å†æœ‰â€œå‰åå¤¹å‡»â€çš„é€»è¾‘
                    prizeToShow = activePrizes[Math.floor(Math.random() * activePrizes.length)];
                }

                const imgUrl = prizeToShow.img.startsWith('/') 
                    ? prizeToShow.img 
                    : `https://placehold.co/100x100/png?text=${prizeToShow.name.substring(0,2)}`;
                
                createCard(prizeToShow, imgUrl);
            }
        }

        function createCard(prize, displayImg) {
            const card = document.createElement('div');
            card.className = `l-card ${prize.rarity}`;
            
            const stockText = prize.stock > 0 ? `å‰©: ${prize.stock}` : `æŠ½å®Œå“©`;
            
            card.innerHTML = `
                <img src="${displayImg}" alt="${prize.name}">
                <p>${prize.name}</p>
                <div class="stock-tag">${stockText}</div>
            `;
            track.appendChild(card);
        }

        // ==========================================
        // 5. åŠ¨ç”»æ§åˆ¶
        // ==========================================

        function startSpin() {
            if (isSpinning) return;

            // 1. é¢„å…ˆå†³å®šç»“æœ
            const winner = getWinner();
            if (!winner) {
                alert("å¤ªå—æ¬¢è¿äº†ï¼Œæ‰€æœ‰å¥–å“å·²å‘å®Œï¼");
                return;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            spinBtn.classList.replace('btn-primary', 'btn-secondary');
            resultDisplay.style.opacity = '0';
            resultDisplay.style.color = ''; 
            resultDisplay.style.textShadow = '';

            // 2. å¤ä½è½¨é“
            track.style.transition = 'none';
            track.style.transform = 'translateX(0)';

            // 3. é‡æ–°ç”Ÿæˆè½¨é“ (æŠŠå† å†›åŸ‹è¿›å»)
            initTrack(winner);

            // 4. è®¡ç®—æ»šåŠ¨è·ç¦» (å¸¦éšæœºåç§»)
            const dim = getCardDimensions();
            // åç§»èŒƒå›´ï¼šÂ±40% å¡ç‰‡å®½åº¦
            const offset = Math.floor(Math.random() * dim.width * 0.8) - (dim.width * 0.4);
            const scrollDistance = (WINNER_INDEX * dim.total) + offset;

            // 5. æ‰§è¡ŒåŠ¨ç”»
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    // è´å¡å°”æ›²çº¿ï¼šå…ˆæå¿«ï¼Œåææ…¢
                    track.style.transition = `transform ${SPIN_DURATION}ms cubic-bezier(0.1, 0.7, 0.1, 1)`;
                    track.style.transform = `translateX(-${scrollDistance}px)`;
                });
            });

            // 6. ç»“æŸç»“ç®— (ä¿®æ”¹äº†æ–‡å­—æ˜¾ç¤ºé€»è¾‘)
            setTimeout(() => {
                isSpinning = false;
                spinBtn.disabled = false;
                spinBtn.classList.replace('btn-secondary', 'btn-primary');

                // æ‰£å‡åº“å­˜
                const realPrize = prizes.find(p => p.id === winner.id);
                if(realPrize && realPrize.stock > 0) {
                    realPrize.stock--;
                    saveData();
                    renderPrizePool(); // åˆ·æ–°ä¸‹æ–¹åˆ—è¡¨
                }

                // === ç»“æœå±•ç¤ºä¸ç‰¹æ•ˆ ===
                resultDisplay.innerText = `ğŸ‰ æ­å–œè·å¾—ï¼š${winner.name}`;
                resultDisplay.style.opacity = '1';
                
                // 1. æ¸…é™¤æ—§çš„ç‰¹æ•ˆç±»
                resultDisplay.className = ''; 
                // 2. æ ¹æ®ç¨€æœ‰åº¦æ·»åŠ å¯¹åº”çš„é—ªçƒç±»
                if(winner.rarity === 'rare-gold') {
                    resultDisplay.classList.add('text-glow-gold');
                } else if (winner.rarity === 'rare-red') {
                    resultDisplay.classList.add('text-glow-red');
                }

                // è§¦å‘çƒŸèŠ±
                triggerConfettiEffect(winner.rarity);

            }, SPIN_DURATION);
        }

        // ==========================================
        // è§†è§‰ç‰¹æ•ˆ (Confetti) - æœ€ç»ˆå¢å¼ºç‰ˆ
        // ==========================================
        function triggerConfettiEffect(rarity) {
            const defaults = { origin: { y: 0.7 }, zIndex: 9999 };
            
            if (rarity === 'rare-red') {
                // === ğŸ”´ çº¢è‰²å¤§å¥–ï¼šå…¨å±æŒç»­è½°ç‚¸ (ä¸¤ä¾§+ä¸­é—´) ===
                const duration = 3000;
                const end = Date.now() + duration;
                const colors = ['#DC2626', '#FF0000', '#F59E0B', '#FFFFFF'];

                (function frame() {
                    // 1. ä¸¤ä¾§æŒç»­å–·å°„ (åŠ å†œç‚®)
                    confetti({
                        particleCount: 4,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: colors
                    });
                    confetti({
                        particleCount: 4,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: colors
                    });

                    // 2. ä¸­é—´éšæœºçˆ†å‘ (æ¯éš”ä¸€ç‚¹æ—¶é—´ç‚¸ä¸€ä¸‹)
                    if (Date.now() % 400 < 20) { // çº¦æ¯400msè§¦å‘ä¸€æ¬¡
                        confetti({
                            particleCount: 20,
                            angle: 90,
                            spread: 120, // å¹¿è§’
                            origin: { x: 0.5, y: 0.6 },
                            colors: colors,
                            scalar: 1.5, // ç²’å­æ›´å¤§
                            drift: 0,
                            startVelocity: 45
                        });
                    }

                    if (Date.now() < end) {
                        requestAnimationFrame(frame);
                    }
                }());

            } else if (rarity === 'rare-gold') {
                // === ğŸŸ¡ é‡‘è‰²ä¼ è¯´ï¼šç»å…¸ç‰ˆ (ä¸¤ä¾§å–·å°„ + ä¸­é—´æµæ˜Ÿé›¨) ===
                const count = 200;
                const colors = ['#F59E0B', '#FCD34D', '#FFFBEB', '#FFD700'];
                
                // å·¦ä¾§
                confetti({ ...defaults, particleCount: count / 2, angle: 60, spread: 60, origin: { x: 0.1, y: 0.6 }, colors: colors });
                // å³ä¾§
                confetti({ ...defaults, particleCount: count / 2, angle: 120, spread: 60, origin: { x: 0.9, y: 0.6 }, colors: colors });
                
                // å»¶è¿Ÿè½ä¸‹æ˜Ÿæ˜Ÿé›¨ (æ¢å¤ä½ æƒ³è¦çš„æ•ˆæœ)
                setTimeout(() => { 
                    confetti({ 
                        particleCount: 60, 
                        spread: 100, 
                        origin: { y: 0.6, x: 0.5 }, // ç¡®ä¿ä»ä¸­é—´è½ä¸‹
                        colors: colors, 
                        shapes: ['star'], 
                        scalar: 1.2,
                        gravity: 0.8
                    }); 
                }, 400);

            } else if (rarity === 'rare-purple') {
                // === ğŸŸ£ ç´«è‰²å²è¯— ===
                confetti({ ...defaults, particleCount: 300, spread: 120, colors: ['#8B5CF6', '#D8B4FE', '#C084FC'] });
                
            } else {
                // === ğŸ”µ è“è‰²æ™®é€š ===
                confetti({ ...defaults, particleCount: 100, spread: 80, colors: ['#3B82F6', '#93C5FD'] });
            }
        }

        // é¦–æ¬¡åŠ è½½
        initTrack();
        renderPrizePool();

        // ç›‘å¬çª—å£è°ƒæ•´ (ä¿®æ­£è½¨é“ä½ç½®)
        window.addEventListener('resize', () => {
            if(!isSpinning) {
                track.style.transition = 'none';
                track.style.transform = 'translateX(0)';
            }
        });

    </script>
</body>
</html>